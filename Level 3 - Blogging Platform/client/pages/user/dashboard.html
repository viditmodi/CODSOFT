<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="stylesheet" href="../../css/main.css" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
    />

    <script src="../../templates/header.js"></script>
    <script src="../../templates/footer.template.js"></script>
    <script src="../../templates/sideNavBar.js"></script>
    <script src="../../templates/gallery.js"></script>
    <script src="../../js/auth.js"></script>
    <script src="../../templates/loader.js"></script>
    <script src="/js/data/apiURLs.js"></script>


    <title>Document</title>
  </head>
  <body onload="onLoadHandler()">
    <header class="header" id="Header"></header>

    <div class="dashboard grid-container">
      <!-- red-f// DASHBOARD LEFT  -->
      <div class="dashboard__left grid-container__left">
        <div class="idcard__container">
          <!-- <div class="idcard__hook"></div> -->
          <div class="idcard idcard--front">
            <div class="idcard__design idcard__design--tl"></div>
            <div class="idcard__design idcard__design--br"></div>
            <div class="idcard__content idcard__content--front">
              <!-- logo (with name?) -->
              <div class="idcard__logo idcard__logo--front">
                <img src="../../assets/images/logo.png" alt="logo" />
              </div>
              <!-- profile image -->
              <div class="idcard__image-container">
                <div>
                  <img
                    src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=Example"
                    alt="profile"
                  />
                </div>
              </div>
              <!-- username -->
              <p class="idcard__name" id="usernameTag">name here</p>
              <!-- tier -->
              <p class="idcard__tier" id="tierTag">name here</p>
              <!-- immutable data -->
              <div class="idcard__data-container">
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="blogTag">data</p>
                  <p class="idcard__data--heading">blogs</p>
                  <!-- <span class="idcard__data--icon"></span> -->
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="postTag">data</p>
                  <p class="idcard__data--heading">posts</p>
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="viewsTag">data</p>
                  <p class="idcard__data--heading">views</p>
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="likesTag">data</p>
                  <p class="idcard__data--heading">followers</p>
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="commentsTag">data</p>
                  <p class="idcard__data--heading">comments</p>
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="followingTag">data</p>
                  <p class="idcard__data--heading">following</p>
                </div>
                <div class="idcard__data">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="joinedTag">data</p>
                  <p class="idcard__data--heading">joined</p>
                </div>
              </div>
            </div>
          </div>
          <div class="idcard idcard--back">
            <div class="idcard__design idcard__design--tr"></div>
            <div class="idcard__design idcard__design--bl"></div>

            <div class="idcard__content idcard__content--back">
              <!-- logo (with name?) -->
              <div class="idcard__logo idcard__logo--back">
                <img src="../../assets/images/logo.png" alt="logo" />
              </div>
              <!-- profile image -->
              <div class="idcard__image-container">
                <img
                  src="https://beforeigosolutions.com/wp-content/uploads/2021/12/dummy-profile-pic-300x300-1.png"
                  alt="profile"
                  id="profileImageTag"
                />
              </div>
              <!-- name -->
              <p class="idcard__name" id="backUsernameTag">name here</p>
              <!-- tier -->
              <p class="idcard__tier" id="backTierTag">name here</p>

              <!-- mutable data -->
              <div class="idcard__profile">
                <div class="idcard__profile__firstname idcard__profile__field">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="nameTag">data data</p>
                  <p class="idcard__data--heading">name</p>
                  <!-- <span class="idcard__data--icon"></span> -->
                </div>
                <div class="idcard__profile__lastname idcard__profile__field">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="emailTag">
                    data@data.com
                  </p>
                  <p class="idcard__data--heading">email</p>
                </div>
                <div class="idcard__profile__field">
                  <!-- <span class="idcard__data--icon"></span> -->
                  <p class="idcard__data--content" id="phoneTag">9874563215</p>
                  <p class="idcard__data--heading">phone</p>
                </div>
              </div>
            </div>

            <div class="idcard__form--togglebtn">
              <button class="btn" onclick="showProfileForm()">edit</button>
            </div>

            <form class="idcard__form" id="profileFormContainer">
              <div class="idcard__image-container">
                <img
                  src="/assets/images/default_blog.png"
                  alt="thumbnail"
                  id="blogThumbnailImage"
                  class=""
                />
                <input
                  type="file"
                  name="profileImage"
                  id="profileImage"
                  onchange="previewImage(event)"
                  class="new-blog__thumbnail__input"
                />
                <span
                  class="btn new-blog__thumbnail__btn"
                  onclick="uploadImage()"
                >
                  U
                </span>
              </div>

              <input
                type="text"
                name="profileFormName"
                id="profileFormName"
                class="textbox"
                placeholder="name"
              />
              <input
                type="text"
                name="profileFormPhone"
                id="profileFormPhone"
                class="textbox"
                placeholder="Contact"
              />

              <button type="submit">update</button>
            </form>
          </div>
        </div>
      </div>
      <!-- red-f// DASHBOARD LEFT  -->
      <div class="dashboard__right grid-container__right">
        <!-- <section class="wrapper" id="container"></section> -->
        <section class="wrapper" id="galleryContainer"></section>
      </div>
    </div>

    <footer id="Footer"></footer>

    <script>
      const loadData = {
        logoURL: "../../assets/images/logo.png",
        navBarData: [
          {
            link: "/pages/user/dashboard.html",
            text: "dashboard",
            active: true,
          },
          {
            link: "/pages/user/blogs.html",
            text: "blogs",
          },
          {
            link: "/pages/user/posts.html",
            text: "posts",
          },
          {
            link: "/pages/auth/logout.html",
            text: "logout",
          },
        ],
      };
      const header = document.getElementById("Header");
      const body = document.getElementsByTagName("body")[0];

      //<!-- blue-f// On Load Function
      createLoader();
      const onLoadHandler = async () => {
        if (!(await checkLoginStatus())) {
          window.location.href = "/pages/auth/login.html";
        }
        await createHeader(header, loadData);
        await createSideNavBar(loadData.navBarData);
        await createFooter();

        const idCardData = JSON.parse(
          localStorage.getItem("quillcraft_userdata")
        );
        await setIDCard(idCardData);

        try {
          const response = await fetch(followBlogURL+`?username=${idCardData.username}`)
          const res = await response.json()

          console.log(res)
          createGallery(
              document.getElementById("galleryContainer"),
              "blog",
              "Blogs For You",
              res.data
            );
        } catch (error) {
          console.log(error)
        }
        removeLoader();
      };
    </script>

    <!-- red-f// Set ID Card -->
    <script>
      const setIDCard = (data) => {
        console.log(data);
        const blogTag = document.getElementById("blogTag");
        const postTag = document.getElementById("postTag");
        const viewsTag = document.getElementById("viewsTag");
        const likesTag = document.getElementById("likesTag");
        const commentsTag = document.getElementById("commentsTag");
        const followingTag = document.getElementById("followingTag");
        const joinedTag = document.getElementById("joinedTag");
        const profileImageTag = document.getElementById("profileImageTag");


        const usernameTag = document.getElementById("usernameTag");
        const tiertag = document.getElementById("tierTag");

        const backUsernameTag = document.getElementById("backUsernameTag");
        const backTierTag = document.getElementById("backTierTag");

        const nameTag = document.getElementById("nameTag");
        const emailTag = document.getElementById("emailTag");
        const phoneTag = document.getElementById("phoneTag");

        usernameTag.innerText = data.username;
        tiertag.innerText = data.user_tier;
        blogTag.innerText = data.total_blogs;
        postTag.innerText = data.total_posts;
        viewsTag.innerText = data.total_views;
        likesTag.innerText = data.total_followers;
        commentsTag.innerText = data.total_comments;
        followingTag.innerText = data.following.length
        // console.log(data.joining)
        joinedTag.innerText = new Date(data.joining? data.joining : data.createdAt).toLocaleDateString();
        profileImageTag.src = data.image_url

        backUsernameTag.innerText = data.username
        backTierTag.innerText = data.user_tier

        nameTag.innerText = data.first_name + " " + data.last_name
        emailTag.innerText = data.email
        phoneTag.innerText = data.phone
        // new Date().toLocaleDateString
        return Promise.resolve();
      };
    </script>

    <!-- red-f// Show Profile Edit Form -->
    <script>
      const userdata = JSON.parse(localStorage.getItem("quillcraft_userdata"));
      const showProfileForm = () => {
        const profileFormContainer = document.getElementById(
          "profileFormContainer"
        );
        profileFormContainer.style.width = "100%";
        profileFormContainer.style.padding = "2rem";
      };

      const profileForm = document.getElementById("profileFormContainer");
      profileForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        const name = document
          .getElementById("profileFormName")
          .value.split(" ");
        const phone = document.getElementById("profileFormPhone").value;
        const profileImage = document.getElementById("profileImage")

        // const profileData = {
        //   first_name: ,
        //   last_name: ,
        //   phone: phone,
        // };

        const profileData = new FormData()
        profileData.append("profile_image", profileImage.files[0])
        profileData.append("first_name", name.slice(0, name.length - 1).join(" "))
        profileData.append("last_name", name[name.length - 1])
        profileData.append("phone", phone)
        try {
          const response = await fetch(accountBaseURL + userdata.username, {
            method: "PUT",
            // headers: { "Content-Type": "application/json" },
            body: profileData,
          });
          const res = await response.json();

          console.log(res);
          if(!res.status){}

          const profileFormContainer = document.getElementById(
          "profileFormContainer"
        );
        profileFormContainer.style.width = "0%";
        profileFormContainer.style.padding = "0rem";

        
          localStorage.setItem("quillcraft_userdata", JSON.stringify(res.data))
        await setIDCard(res.data);
        } catch (error) {
          console.log(error);
        }
      });
    
    

      const previewImage = (event) => {
        const blogThumbnail = document.getElementById("blogThumbnailImage");
        let input = event.target;
        //  var image = document.getElementById('preview');
        if (input.files && input.files[0]) {
          let reader = new FileReader();
          reader.onload = function (e) {
            blogThumbnail.src = e.target.result;
          };
          reader.readAsDataURL(input.files[0]);
        }
      };

      const uploadImage = ()=>{
        // e.preventDefault()
        const blogThumbnail = document.getElementById("profileImage")
        blogThumbnail.click()
      }
    </script>
  </body>
</html>
